<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article - ModernNews</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">ðŸ“° ModernNews</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="index.html" onclick="goToHome('ICT'); return false;">ICT</a></li>
        <li><a href="index.html" onclick="goToHome('Nature'); return false;">Nature</a></li>
        <li><a href="index.html" onclick="goToHome('Technology'); return false;">Technology</a></li>
        <li><button id="adminBtn" class="btn-admin">Admin</button></li>
        <li><button id="logoutBtn" class="btn-logout hidden">Logout</button></li>
      </ul>
    </div>
  </nav>

  <!-- Article Content -->
  <div class="container">
    <div class="article-full" id="articleContainer">
      <div style="text-align: center; color: #999; padding: 40px;">
        <p>Loading article...</p>
      </div>
    </div>
  </div>

  <!-- Related Articles Section -->
  <section class="articles-section" style="background-color: #f9f9f9;">
    <div class="container">
      <h2 class="section-title">More Articles</h2>
      <div class="articles-grid" id="relatedArticlesContainer">
        <div class="empty-state"><p>No related articles found.</p></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer style="background-color: #2c3e50; color: white; text-align: center; padding: 30px 20px; margin-top: 50px;">
    <div class="container">
      <p>&copy; 2025 ModernNews. All rights reserved. | Powered by Firebase</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script type="module">
    import { db } from './firebaseConfig.js';
    import { doc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { checkAuthState, logoutAdmin } from './auth.js';

    let currentArticleCategory = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      // Check auth state
      checkAuthState((user) => {
        updateNavigation(user);
      });

      // Setup logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          logoutAdmin().then(() => {
            window.location.href = 'index.html';
          });
        });
      }

      // Setup admin button
      const adminBtn = document.getElementById('adminBtn');
      if (adminBtn) {
        adminBtn.addEventListener('click', function() {
          window.location.href = 'admin-login.html';
        });
      }

      // Get article ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const articleId = urlParams.get('id');

      if (!articleId) {
        showError('Article not found. Redirecting...');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }

      await loadArticle(articleId);
      await loadRelatedArticles();
    });

    /**
     * Update navigation based on auth state
     */
    function updateNavigation(user) {
      const adminBtn = document.getElementById('adminBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      if (user) {
        if (adminBtn) adminBtn.classList.add('hidden');
        if (logoutBtn) logoutBtn.classList.remove('hidden');
      } else {
        if (adminBtn) adminBtn.classList.remove('hidden');
        if (logoutBtn) logoutBtn.classList.add('hidden');
      }
    }

    /**
     * Load article from Firestore
     */
    async function loadArticle(articleId) {
      try {
        const docRef = doc(db, 'posts', articleId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          showError('Article not found.');
          return;
        }

        const article = docSnap.data();
        currentArticleCategory = article.category;

        displayArticle(article);
        // Update page title
        document.title = article.title + ' - ModernNews';
      } catch (error) {
        console.error('Error loading article:', error);
        showError('Error loading article: ' + error.message);
      }
    }

    /**
     * Display article content
     */
    function displayArticle(article) {
      const container = document.getElementById('articleContainer');
      container.innerHTML = `
        <img src="${article.imageUrl}" alt="${article.title}" class="article-full-image" onerror="this.src='https://via.placeholder.com/800x400?text=No+Image'">
        
        <div class="article-full-header">
          <span class="article-full-category">${article.category}</span>
          <h1 class="article-full-title">${article.title}</h1>
          <div class="article-full-meta">
            <span id="publishDate"></span>
          </div>
        </div>

        <div class="article-full-content">
          ${formatArticleText(article.fullArticle)}
        </div>
      `;

      // Format and display date
      if (article.createdAt) {
        const date = new Date(article.createdAt.seconds * 1000);
        const formattedDate = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('publishDate').textContent = 'Published: ' + formattedDate;
      }
    }

    /**
     * Format article text with paragraph breaks
     */
    function formatArticleText(text) {
      return text
        .split('\n')
        .filter(para => para.trim())
        .map(para => `<p>${para.trim()}</p>`)
        .join('');
    }

    /**
     * Load related articles from same category
     */
    async function loadRelatedArticles() {
      try {
        const postsRef = collection(db, 'posts');
        const q = query(
          postsRef,
          orderBy('createdAt', 'desc'),
          limit(6)
        );

        const snapshot = await getDocs(q);
        const articles = [];

        snapshot.forEach(doc => {
          articles.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Filter to same category or show all if none match
        let related = articles.filter(a => a.category === currentArticleCategory).slice(0, 3);
        if (related.length < 3) {
          related = articles.slice(0, 3);
        }

        displayRelatedArticles(related);
      } catch (error) {
        console.error('Error loading related articles:', error);
      }
    }

    /**
     * Display related articles
     */
    function displayRelatedArticles(articles) {
      const container = document.getElementById('relatedArticlesContainer');

      if (articles.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No related articles found.</p></div>';
        return;
      }

      container.innerHTML = articles.map(article => `
        <div class="article-card" onclick="viewArticle('${article.id}')">
          <img src="${article.imageUrl}" alt="${article.title}" class="article-image" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
          <div class="article-content">
            <span class="article-category">${article.category}</span>
            <h2 class="article-title">${article.title}</h2>
            <p class="article-description">${article.shortDescription}</p>
            <a href="fullarticle.html?id=${article.id}" class="article-read-more">Read More â†’</a>
          </div>
        </div>
      `).join('');
    }

    /**
     * Show error message
     */
    function showError(message) {
      const container = document.getElementById('articleContainer');
      container.innerHTML = `
        <div class="empty-state" style="padding: 60px 20px;">
          <p style="color: #d32f2f; font-size: 18px;">${message}</p>
        </div>
      `;
    }

    /**
     * Navigate to article
     */
    window.viewArticle = function(articleId) {
      window.location.href = `fullarticle.html?id=${articleId}`;
    };

    /**
     * Go to home with category filter
     */
    window.goToHome = function(category) {
      window.location.href = `index.html?category=${category}`;
    };
  </script>
</body>
</html>
